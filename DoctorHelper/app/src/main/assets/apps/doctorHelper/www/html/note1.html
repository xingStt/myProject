<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>便签</title>
		<link rel="stylesheet" href="../css/mui.min.css" />
		<script type="text/javascript" src="../script/mui.min.js"></script>
		<script type="text/javascript" src="../script/zepto.min.js"></script>
		<script type="text/javascript" src="../script/Url.js" ></script>
		<style type="text/css">
			* {
				-webkit-user-select: none;
				-ms-touch-select: none;
			}
			
			body {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				font-size: 16px;
				color: #6c6c6c;
			}
			
			.dcontent {
				text-align: center;
				padding-top: 44px;
				padding-bottom: 80px;
			}
			
			.button {
				font-size: 18px;
				font-weight: normal;
				text-decoration: none;
				display: block;
				text-align: center;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				color: #FFF;
				background-color: #FFCC33;
				border: 1px solid #ECB100;
				padding: .5em 0em;
				margin: .5em .7em;
				-webkit-border-radius: 5px;
				border-radius: 5px;
			}
			
			.button:active {
				outline: 0;
				-webkit-box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
				box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
			}
			
			.rp {
				width: 100%;
				height: 100%;
				display: none;
				text-align: center;
				position: fixed;
				top: 0;
				background: rgba(0, 0, 0, 0.8);
				z-index: 9999;
				overflow: hidden;
			}
			
			.rtime {
				font-size: 22px;
				color: #FF0000;
			}
			
			.start {
				margin: 0 auto;
				width: 4rem;
				height: 4rem;
				background-image: url(../image/audio/icon_star.png);
				background-size: cover;
				background-repeat: no-repeat;
			}
			
			.stop {
				margin: 0 auto;
				width: 4rem;
				height: 4rem;
				background-image: url(../image/audio/icon_finish.png);
				background-size: cover;
				background-repeat: no-repeat;
			}
			
			.stop:active {
				-webkit-box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5) inset;
				box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5) inset;
			}
			
			.mui-bar {
				background: #0FA3E5;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #FFF;"></a>
			<span id="toNoteFile" class="mui-title" style="color: #FFF;font-size: 1.1rem;">便签</span>
			<a id="btnComplete" style="color: #FFF;float: right;margin-top: 0.8rem;">完成</a>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded" style="padding: 0;margin:0;overflow: auto;">
				<div class="mui-input-row">
					<textarea id="note" rows="10" placeholder="请输入文字"></textarea>
				</div>
				<div >
					图片
					<a id="camera" style="margin-right: 1.5rem;"><span style="font-size: 1.5rem;" class="mui-icon mui-icon-plusempty"></span></a>
				</div>
				<div id="picbox" style="margin: 0.5rem;">
				</div>
				<div >
					视频
					<a id="video" style="margin-right: 1.5rem;"><span style="font-size: 1.5rem;" class="mui-icon mui-icon-plusempty"></span></a>
				</div>
				<div id="videobox" style="margin: 0.5rem;">
				</div>
				<div >
					录音
					<a id="recordBtn" style="margin-right: 1.5rem;"><span style="font-size: 1.5rem;" class="mui-icon mui-icon-plusempty"></span></a>
				</div>
				<div id="recordbox" style="margin: 0.5rem;">
				</div>
			</div>
		</div>
		<div id="uploading" style="position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: 10;
			background:#F6F6F6;display: none;padding-top: 20%;">
			<div style="text-align: center;color: #999;font-size: 2rem;">
				正在上传数据。。。
			</div>
		</div>
		<div id="dcontent" class="dcontent">
			<!--<div class="button" id="camera">照片</div>-->
			<!--<div class="button" id="video">录像</div>
			<div class="button" id="recordBtn">录音</div>-->
		</div>
		<div id="record" class="rp">
			<div style="width:100%;height:40%;"></div>
			<div id="rtime" class="rtime">00:00:00</div><br/>
			<div class="stop" style="float: left;" onclick="deleteRecord()">删除</div>
			<div id="recordDiv" style="float: left;" class="start">start</div>
			<div class="stop" style="float: left;" onclick="saveRecord()">保存</div>
		</div>
		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a id="btnCamera" href="javascript:void(0)">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="btnAlbum" href="javascript:void(0)">选取现有照片</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a id="btnCancel" href="#picture"><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>

</html>
<script type="text/javascript">
	//$("#ff").attr("src","ftp://192.168.1.176/n100686/20171207/audio/111.png");
	$("#toNoteFile").bind('tap',function(){
		mui.openWindow({
			url:'noteInfo.html',
			id:'noteInfo'
		});
	});
	mui.init();
	var cmr = null; //摄像头对象
	var aud = null; //audio对象
	var gentry = null;
	var er = null;
	var audioCount = 0;
	var audios = []; //连续录音的录音路径数组
	var audioPath = null; //当前录音路径
	var photoCount = 0;
	var photos = [];
	var videoCount = 0;
	var videos = [];
	// 开始录音
	var r = null,
		t = 0,
		ri = null, //定时器
		rt = null; //录音时间
	document.addEventListener('DOMContentLoaded', function() {
		// 获取DOM元素对象
		er = document.getElementById('record');
		rt = document.getElementById('rtime');
	}, false);
	
	mui.plusReady(function() {
		// 获取音频目录对象
		plus.io.resolveLocalFileSystemURL('_doc/', function(entry) {
			entry.getDirectory('audio', {
				create: true
			}, function(dir) {
				gentry = dir;
			}, function(e) {
				mui.toast('Get directory "audio" failed: ' + e.message);
			});
		}, function(e) {
			mui.toast('Resolve "_doc/" failed: ' + e.message);
		});
		cmr = plus.camera.getCamera();
		aud = plus.audio.getRecorder();
		//录像
		document.getElementById('video').addEventListener('tap', function() {
			cmr.startVideoCapture(function(p) {
				plus.io.resolveLocalFileSystemURL(p, function(entry) {
					//var path = plus.io.convertLocalFileSystemURL(p);
					//$("#picbox").append('<video id="ddd" width="200px" height="200px" controls="controls" src='+path+'></video>')
					showVideo(p);
				}, function(e) {
					console.log("读取录像文件错误：" + e.message);
				});
			}, function(e) {}, {
				filename: "_doc/video/", //文件保存目录
				index: 2
			});
			
			/* var File = plus.android.importClass("java.io.File");
	        var Uri = plus.android.importClass("android.net.Uri");
	        var MediaStore = plus.android.importClass("android.provider.MediaStore");
	        var Intent = plus.android.importClass("android.content.Intent");
	        var intent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);
	        var timeS = Date.parse(new Date());
	        var outPutPath = plus.io.convertLocalFileSystemURL("_doc/video/"+timeS+".mp4");
	        var file = new File(outPutPath);
	        var outPutUri = Uri.fromFile(file);
	        intent.putExtra(MediaStore.EXTRA_OUTPUT, outPutUri);//录像输出位置
	        intent.putExtra(MediaStore.EXTRA_VIDEO_QUALITY,1); //0 最低质量, 1高质量
	        intent.putExtra(MediaStore.EXTRA_DURATION_LIMIT, 10);//控制录制时间单位秒
	        var main = plus.android.runtimeMainActivity();
	        main.startActivityForResult(intent,1);
	        main.onActivityResult = function(request, code, data) {
	            //停止录像
	            console.log(outPutPath)//输出文件位置
	            showVideo(outPutPath);
	    	}*/
			
		});
		document.getElementById("recordDiv").addEventListener('tap', function() {
			if($(this).hasClass('start')) {
				$(this).removeClass('start');
				$(this).addClass('stop');
				startRecord();
			} else {
				$(this).removeClass('stop');
				$(this).addClass('start');
				stopRecord();
			}
		});
		$("#btnComplete").bind('tap',function(){
			mui.confirm('确认上传', '', ['确认', '取消'], function(e) {
				if(e.index == 0) {
					$("#uploading").show();
					upload();
				} else {}
			});
		});
		function upload() {
			var note = 　document.getElementById("note").value;
			var task = plus.uploader.createUpload(Url_+"/deskNurse/doctor/uploadNote.do", {
					method: "POST"
				},
				function(t, status) { //上传完成
					if(status == 200) {
						$("#uploading").hide();
						//cleanHistory();
						mui.back();
					} else {
						mui.toast("文件上传失败");
					}
				}
			);
			task.addData('note',note);
			task.addData('empid',localStorage.getItem("loginid"));
			task.addData('patientid',localStorage.getItem("patientid"));
			for(var i = 0; i < photos.length; i++) {//所有图片
				var p = photos[i];
				task.addFile(p.path, {
					key: p.name
				});
			}
			for(var i = 0; i < videos.length; i++) {//所有视频
				var v = videos[i];
				task.addFile(v.path, {
					key: v.name
				});
			}
			for(var i = 0; i < audios.length; i++) {//所有录音
				var a = audios[i];
				task.addFile(a.path, {
					key: a.name
				});
			}
			task.start();
		}
	})

	$('#camera').on('tap', function() {
		mui('#picture').popover('show');
	});
	$("#btnCamera").bind('tap', function() {
		UCam();
		mui('#picture').popover('hide');
	});
	$("#btnAlbum").bind('tap', function() {
		galleryPic("vedio");
		mui('#picture').popover('hide');
	});
	$("#recordBtn").bind('tap', function() {
		showRecord();
	});

	//拍照
	function UCam() {
		plus.camera.getCamera().captureImage(function(p) {
			showPic(p)
		}, function(e) {
			console.info("失败：" + e.message);
		}, {
			filename: "_doc/camera/",
			index: 1
		});
	}
	//从相册选择图片
	function galleryPic(type) {
		plus.gallery.pick(function(e) {
			var fiLength = e.files.length;
			for(var i = 0; i < fiLength; i++) {
				showPic(e.files[i]);
			}
		}, function(e) {
			console.info("取消选择");
		}, {
			filter: type,
			system: true,
			multiple: true
		})
	}
	//压缩展示图片
	function showPic(imgurl) {
		var pt = imgurl;
		plus.zip.compressImage({
			src: pt,
			dst: pt,
			quality: 100,
			overwrite: true,
			format: "png",
			width: "800px",
			height: "1280px"
		}, function(e) {
			var path = plus.io.convertLocalFileSystemURL(e.target);
			var photo = {
				name: pt,
				path: path
			}
			$("#picbox").append('<p style="float: left;" id="p_' + photoCount + '">"p_' + photoCount + '"<span class="mui-icon mui-icon-closeempty">' +
				'</span><img class="p_' + photoCount + '" width="200px" height="200px" src="' + path + '"></p>');
			$('#p_' + photoCount).find('span').on('tap', function() {
				$(this).parent().remove();
				photos.remove(photo);
			});
			photos.push(photo);
			photoCount++;
		}, function() {});
	}

	function showVideo(videoUrl) {
		var name = videoUrl;
		var path = plus.io.convertLocalFileSystemURL(videoUrl);
		console.info(path);
		var video = {
			name: name,
			path: path
		};
		$("#videobox").append('<p style="float: left;" id="v_' + videoCount + '">"v_' + videoCount + '"<span class="mui-icon mui-icon-closeempty">' +
			'</span><video width="200px" height="200px" controls="controls" src=' + path + '></video></p>');
		$('#v_' + videoCount).find('span').on('tap', function() {
			$(this).parent().remove();
			videos.remove(video);
		});
		videos.push(video);
		videoCount++;
	}

	function showRecord() {
		er.style.display = 'block';
	}
	//开始录音
	function startRecord() {
		r = plus.audio.getRecorder();
		if(r == null) {
			mui.toast('录音对象未获取');
			return;
		}
		r.record({
			filename: '_doc/audio/'
		}, function(p) {
			audioPath = p;
		}, function(e) {
			mui.toast('录音失败:' + e.message);
		});
		t = 0;
		ri = setInterval(function() {
			t++;
			rt.innerText = timeToStr(t);
		}, 1000);
	}
	//删除录音
	function deleteRecord() {
		clearInterval(ri);
		if(r) {
			r.stop();
		}
		setTimeout(function() {
			mui.confirm('确认删除该' + audioPath + '条记录？', '', ['确认', '取消'], function(e) {
				if(e.index == 0) {
					deleteRecordEvent();
				} else {}
			});
		}, 500);
	}
	// 停止录音
	function stopRecord() {
		clearInterval(ri);
		ri = null;
		r.stop();
		r = null;
		t = 0;
	}
	//保存录音
	function saveRecord() {
		clearInterval(ri);
		if(r) {
			r.stop();
		}
		setTimeout(function() {
			mui.confirm('确认保存' + audioPath, '', ['保存', '放弃'], function(e) {
				if(e.index == 0) {
					var path = plus.io.convertLocalFileSystemURL(audioPath)
					var audio={
							name: audioPath,
							path: path
						}
					$("#recordbox").append('<p style="float: left;" id="a_' + audioCount + '">"a_' + audioCount + '"<span class="mui-icon mui-icon-closeempty">' +
						'</span><audio controls="controls" src='+path+'>您的浏览器不支持 audio 标签。</audio></p>');
					$('#a_' + audioCount).find('span').on('tap', function() {
						$(this).parent().remove();
						audios.remove(audio);
					});
					audios.push(audio);
					audioCount++;
					closeEvent();
				} else {
					deleteRecordEvent();
				}
			});
		}, 500);
	}
	// 重写关闭
	mui.back = function() {
		if(er.style.display == 'block') {
			closeEvent();
		} else {
			plus.webview.currentWebview().close();
		}
	}
	//删除录音进行的操作
	function deleteRecordEvent() {
		plus.io.resolveLocalFileSystemURL(audioPath, function(entry) {
			entry.remove(function(e) {
				rt.innerText = '00:00:00';
			}, function() {
				mui.toast("删除失败")
			});
		})
	}
	//关闭录音界面的操作
	function closeEvent() {
		$("#record").css("display", "none");
		rt.innerText = '00:00:00';
		clearInterval(ri);
		if(r) {
			r.stop();
		}
		if($("#recordDiv").hasClass('stop')) {
			$("#recordDiv").removeClass('stop');
			$("#recordDiv").addClass('start');
		}
	}
	// 格式化时长字符串，格式为"HH:MM:SS"
	timeToStr = function(ts) {
		if(isNaN(ts)) {
			return "--:--:--";
		}
		var h = parseInt(ts / 3600);
		var m = parseInt((ts % 3600) / 60);
		var s = parseInt(ts % 60);
		return(ultZeroize(h) + ":" + ultZeroize(m) + ":" + ultZeroize(s));
	};
	ultZeroize = function(v, l) {
		var z = "";
		l = l || 2;
		v = String(v);
		for(var i = 0; i < l - v.length; i++) {
			z += "0";
		}
		return z + v;
	};
	//找出数组元素下标
	Array.prototype.indexOf = function(val) {
		for(var i = 0; i < this.length; i++) {
			if(this[i] == val) return i;
		}
		return -1;
	};
	//删除指定元素
	Array.prototype.remove = function(val) {
		var index = this.indexOf(val);
		if(index > -1) {
			this.splice(index, 1);
		}
	};
</script>